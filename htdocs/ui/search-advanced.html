<div class="container">
  <div class="sixteen columns advsearch">
	  
	  <noscript>
		  <center>
		  	JavaScript is needed for the advanced search feature to work.
		  </center>
	  </noscript>
	 
    <div class='search-div'>
      <div>
		<label style='float: none; display:inline-block; width: auto;' for='qs-input' class='search-title'>Search for equipment:</label>
        <div class='search-cancel'>X</div>
		
        <input id='qs-input' class='search-input' autocomplete='off' name='q' type='search' value='' placeholder='e.g. Microscope'  />
        <input id='search-button' class='search-button' type='submit' value='&#x279C;' title='Start Search'   />
 
      </div>

  	<check if="{{ isset(@adv_org) }}"> 
  	  	<true>
  	    	<div id="adv_org_select">Show only <input name="adv_org" type="radio" value="{{@adv_org['org_uri']}}" id="adv_org_select_org" checked> <label for="adv_org_select_org"> <strong>{{@adv_org['org_name']}}</strong> items</label><check if="{{ isset(@adv_cons) and count(@adv_cons) }}"><F3:repeat group="{{ @adv_cons }}" value="{{ @cons }}">,  <input name="adv_org" type="radio" value="consortia:{{@cons['group_id']}}" id="adv_org_select_{{@cons['group_sname']}}"> <label for="adv_org_select_{{@cons['group_sname']}}"><strong>{{@cons['group_name']}}</strong> items</label></F3:repeat></check>
					 or <input name="adv_org" type="radio" value="0" id="adv_org_select_all"> <label for="adv_org_select_all"><strong>all</strong> items</label></div>
  	    </true> 
	  </check>
  </div>
	 	 
  </div>
   
  </div>
 <div class="container"> 
  
   <div class="three columns advsearch" id="adv_results_sidebar" style="display:none;">
   		<h3>Refine Results</h3>
        <div class="sidebox">
        	<h5>Result Type</h5>
			<input name="filter_type" type="radio" value="all" id="filter_type_all" checked onChange="preformAdvSearch();"> <label for="filter_type_all" >All</label> <br/>
			<F3:repeat group="{{ $eq_config->types }}" value="{{ @v }}" key="{{ @k }}">
				<input name="filter_type" type="radio" value="{{ @k }}" id="filter_type_{{@k}}" onChange="preformAdvSearch();"> <label for="filter_type_{{@k}}">{{@v}}</label><br/>
			</F3:repeat>
		</div>
        <!--div class="sidebox">
        	<h5>Order By Distance</h5>
			<input name="filter_geocode" type="radio" value="all" id="filter_geocode_none" checked onChange="preformAdvSearch();"> <label for="filter_geocode_none" >None</label> <br/>
			<input name="filter_geocode" type="radio" value="all" id="filter_geocode_inst"  onChange="" > <label for="filter_geocode_inst" >Institution</label> <br/>
			<input name="filter_geocode_inst_text" type="text" style="width: 94%;"  id="filter_geocode_inst_text"/>
		</div=-->
   </div>
   
   <div class="thirteen columns advsearch">
   		<h3 id="adv_results_title"></h3>
      	<div id="adv_results">
			
		</div>
   </div>
   
   
   
</div>

<script>
  	<check if="{{ isset(@adv_org) }}"> 
  	  	<true>
			var instsearch = "{{@_REQUEST['instsearch']}}";
  	    </true>
		<false>
			var instsearch = 0;
		</false>
	</check>
	


$( document ).ready(function() {	
	$('#qs-input').on("keypress", function(e) {
	        if (e.keyCode == 13) {
				preformAdvSearch();
	            return false; // prevent the button click from happening
	        }
	});
	
	$('#search-button').on("click", function(e) {
	   		preformAdvSearch();
	        return false; // prevent the button click from happening
	});
	
	checksearch('get');
	
	
	$('h1').append("<sup class=\"beta\">BETA</sup>");
	
	$( "#filter_geocode_inst_text" ).autocomplete({
	      minLength: 2,
	      source: "/api/inst",
	     }
	    );
	
	
});

function proclink(a){
	var link = $(a).attr('href');
	checksearch(link.substr(1));
	return false;
}

function checksearch(qs) {
	if(qs == 'get'){
		qs = document.location.search;
	}
    qs = qs.split("+").join(" ");
    var params = {},
        tokens,
        re = /[?&]?([^=]+)=([^&]*)/g;

    while (tokens = re.exec(qs)) {
        params[decodeURIComponent(tokens[1])]
            = decodeURIComponent(tokens[2]);
    }
	
	if(typeof params.filter != 'undefined'){
		var filters = JSON.parse(params.filter);
	}
	if(typeof filters.type != 'undefined'){
		$('input:radio[name=filter_type][value=\''+filters.type+'\']').prop('checked', true);
	}
	
	if(instsearch){
		if(typeof params.filter != 'undefined'){
			if(typeof filters.consortia != 'undefined'){
				$('input:radio[name=adv_org][value=\'consortia:'+filters.consortia+'\']').prop('checked', true);
			}else if(typeof filters.org != 'undefined'){
				$('#adv_org_select_org').prop('checked', true);
			}else{
				$('#adv_org_select_all').prop('checked', true);
			}
		}else{
			if(typeof params.q == 'undefined' || params.q.length ==0) { 
				$('#adv_org_select_org').prop('checked', true);
			}else{
				$('#adv_org_select_all').prop('checked', true);
			}
		}
	}
	
	if(typeof params.q == 'undefined' || params.q.length ==0) { 
		return false;
	}
	
	$('#qs-input').val(params.q);
  	preformAdvSearchGo(params);
}

function preformAdvSearch(){
	 var query = $('#qs-input').val();
	 
	 var request = {};
	 var filters = {};
	 
	 request.q = query;
	 
	 if(instsearch){
	 	var org_inst = $('input:radio[name=adv_org]:checked').val();
		
		if(org_inst.substring(0,10)=='consortia:'){
			filters.consortia = org_inst.substring(10);
		}else if(org_inst != "0"){
			filters.org = org_inst;
		}

	 	filters.type = $('input:radio[name=filter_type]:checked').val();
		console.log(filters);
		request.instsearch = instsearch;
	 }
	 
	 if(Object.keys(filters).length){
		 request.filter = JSON.stringify(filters);
	 }
	 
	 preformAdvSearchGo(request);
}
 
function preformAdvSearchGo(request){	
	window.history.pushState(request, 'New Search', '/search/advanced?'+$.param( request ));
	$("#adv_results_title").html('Results - loading');
	$("#adv_results").html("<center><img src=\"/resources/images/loading.gif\" style=\"padding:50px\"/></center>");
	
	 $.get( "/api/search", request, resultsAdvSearch);
	
	 
	 
}

function resultsAdvSearch(data){
	$("#adv_results_sidebar").show();
	
	$("#adv_results_title").html('Results - ' + data.total + ' items');
	
	$("#adv_results").html("");
	if(data.total != 0){
		$.each(data.results, function(i, res) {
		  $("#adv_results").append(drawItem(res));
		});	
		
		var ret = '<div class="advpages">';
	
		if(typeof data.previous_page!='undefined'){
			ret += ' <a href="' + data.previous_page + '" onClick="proclink(this); return false;"> &lt; previous page </a>';		
		}
	
		ret += ' Page ' + (data.page+1) + ' of ' + data.total_pages ;
	
		if(typeof data.next_page!='undefined'){
			ret += ' <a href="' + data.next_page + '" onClick="proclink(this); return false;"> next page &gt; </a>';		
		}
		ret += '</div>';

	  $("#adv_results").append(ret	);
			
	}else{
		$("#adv_results").append('<p> We found no items matching your query.</p>');
	}
	
	
	
	
	
	
	
}

function drawItem(item){
	
	
	var pageurl = '/item/' + item.eqID +'.html'
	var ret = '<div class="item">';
	
	if(item.uniquip.Photo.length){
		ret += '<div class="advitemimage img"> <a href="'+ pageurl + '"> <img src="/item/'+item.eqID+'/image.jpg?size=small" /> </a> </div>';
	}else{
		ret += '<div class="advitemimage logo"><a href="'+ pageurl + '"> <img src="/org/' + item.orgID + '.logo?size=small"/> </a> </div>';
	}
	
	ret += '<h3><a href="'+ pageurl + '">' + item.uniquip.Name +'</a></h3>';
	if(item.uniquip.Description.length){
		ret += '<p>' + item.uniquip.Description + '</p>';
	}
	

	ret += '<a href="'+item.uniquip['Institution URL']+'" title="'+item.uniquip['Institution Name']+'">';
	if(item.uniquip['Institution Logo URL'].length){
		ret += '<img src="/org/' + item.orgID + '.logo?size=small" class="advitemlogo">';
	}else{
		ret += item.uniquip['Institution Name'];
	}
	ret += '</a>';
	
	ret += '<div class="clear"></div>';
	
	ret += '</div>';
	
	return ret;
}



</script>