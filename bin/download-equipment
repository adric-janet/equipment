#!/usr/bin/php
<?php

# This script downloads each of the equiment datasets for equipment.data.ac.uk
# And processes them into common formats.

# This takes the list of files to download from a configuration file, which is
# generated from the data at hub.data.ac.uk

# First of all we download each data document and convert it to RDF and cache that.
# If there's a problem, we don't over-ride the previous cache.

# Then we process the cache files to produce a searchable website, and tabular data.


require_once( "lib/arc2/ARC2.php" );
require_once( "lib/Graphite/Graphite.php" );

$base_dir = "/home/dataacuk/data.ac.uk/equipment";

$org_cache_dir = "$base_dir/htdocs/data/org";

$config = read_config( "$base_dir/etc/test-list.tsv" );

foreach( $config as $config_item )
{
	$graph = null;
	if( $config_item["type"] == "rdf" )
	{
		$graph = rdf_to_graph( $config_item ); # TODO
	}
	elseif( $config_item["type"] == "uniquip_csv" )
	{
		$graph = uniquip_csv_to_graph( $config_item ); # TODO
	}
	elseif( $config_item["type"] == "kitcat" )
	{
		$graph = kitcat_to_graph( $config_item );
	}
	else
	{
		print "Unknown type: ".$config_item["type"]."\n";
	}

	if( $graph != null && count( $graph->toArcTriples() ) > 0 ) 
	{
		# cache graph if it's set and has some triples

		# filename has ukprn- as a prefix as in the future there may be data from organisations
		# without a ukprn. Who can say for sure!
		$file = "$org_cache_dir/ukprn-".$config_item["ukprn"].".ttl";
		
		$fh = fopen($file, 'w') or die("can't open file: $file" );
		fwrite($fh, $graph->serialize( "Turtle" ) );
		fclose($fh);
	}
	else
	{
		# don't update cache TODO?
	}
}	

# At this stage, we could delete items from the cache not in the profile
# documents.

foreach( $config as $config_item )
{
	$file = "$org_cache_dir/ukprn-".$config_item["ukprn"].".ttl";

	$graph = new Graphite();
	$n = $graph->load( "file://$file" );
print "$file -- $n\n";
	if( $n == 0 ) { continue; }
	
	print "yo\n";	
}
		
# Output Data Documents & files for search


exit;


function read_config( $file )
{
	$rows = file( $file );

	$config = array();	
	foreach( $rows as $row )
	{
		$cells = preg_split( "/\t/", chop( $row ) );	
		$config []=  array( 
			"ukprn" => $cells[0],	
			"type" => $cells[1],	
			"url" => $cells[2],	
			"name" => $cells[3],	
			"logo" => $cells[4],	
		);
	}
	
	return $config;
}

function rdf_to_graph( $c )
{
	$content = file_get_contents( $c["url"] );
	$items = json_decode( $content, true );

	$graph = new Graphite();

	$n = $graph->load( $c["url"] );

	if( $n==0 ) { return null; }

	return $graph;
}

# INPUT

#        "id": "http://equipment.lboro.ac.uk/id/item/2121",
#        "name": "X-ray Photoelectron Spectrometer",
#        "manufacturer": "Thermo Scientific",
#        "model": "K-Alpha",
#        "description": "<p>Fully...",
#        "contact1": "s.s.doak@lboro.ac.uk",
#        "contact2": "",
#        "image": "http://equipment.lboro.ac.uk/item/x-ray-photoelectron-spectrometer/2121/image/image_41780.jpg",
#        "link": "http://equipment.lboro.ac.uk/id/item/2121/x-ray-photoelectron-spectrometer.html"


function kitcat_to_graph( $c )
{
	$content = file_get_contents( $c["url"] );
	$items = json_decode( $content, true );

	$graph = new Graphite();
	foreach( $items as $item )
	{
		$uri = "http://equipment.data.ac.uk/item/".$c["ukprn"]."/".md5( $item["id"] );

		# assumption-- everything from kitcat is equipment		
		$graph->addCompressedTriple( $uri, "rdf:type", "oo:Equipment" );

		$graph->addCompressedTriple( $uri, "rdfs:label", $item["name"], "literal" );
		$graph->addCompressedTriple( $uri, "oo:formalOrganization", "http://id.learning-provider.data.ac.uk/ukprn/".$c["ukprn"] );

		if( $item["model"] != ""  || $item["manufacturer"] != "" )
		{
			$graph->addCompressedTriple( $uri, "gr:hasMakeAndModel", "$uri#model" );
			$graph->addCompressedTriple( "$uri#model", "rdf:type", "gr:ProductOrServiceModel" );
			if( $item["model"] != "" )
			{
				$graph->addCompressedTriple( "$uri#model", "rdfs:label", $item["model"], "literal" ); 
			}
			if( $item["manufacturer"] != "" )
			{
				$graph->addCompressedTriple( "$uri#model", "gr:hasManufacturer", "$uri#manu" );
				$graph->addCompressedTriple( "$uri#manu", "rdf:type", "gr:BusinessEntity" );
				$graph->addCompressedTriple( "$uri#manu", "rdfs:label", $item["manufacturer"], "literal" ); 
			}
		}

		if( $item["description"] != "" )
		{
			# kitcat always makes HTML fragment descriptions	
			$graph->addCompressedTriple( $uri, "dcterms:description", $item["description"], "http://purl.org/xtypes/Fragment-HTML" );
		}
		
		if( $item["contact1"] != "" )
		{	
			$graph->addCompressedTriple( $uri, "oo:contact", "$uri#contact1" );
			$graph->addCompressedTriple( $uri, "oo:primaryContact", "$uri#contact1" );
			$graph->addCompressedTriple( "$uri#contact1", "foaf:mbox", "mailto:".$item["contact1"] );
		}

		if( $item["contact2"] != "" )
		{	
			$graph->addCompressedTriple( $uri, "oo:contact", "$uri#contact2" );
			$graph->addCompressedTriple( "$uri#contact2", "foaf:mbox", "mailto:".$item["contact1"] );
		}

		if( $item["link"] != "" )
		{	
			$graph->addCompressedTriple( $uri, "foaf:page", $item["link"] );
		}

		if( $item["image"] != "" )
		{	
			$graph->addCompressedTriple( $uri, "foaf:depiction", $item["image"] );
		}
	}
	
	return $graph;
}
